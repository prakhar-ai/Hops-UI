{% extends "base.html" %}
{% block content %}

<script>
    $("a").eq(5).removeClass("active");
    $("a").eq(6).addClass("active");
    </script>

<link href="https://transloadit.edgly.net/releases/uppy/v1.16.1/uppy.min.css" rel="stylesheet">
	<div class="ui tablet stackable steps">
				<div class="active step" id="upload-step">
					<i class="upload icon" ></i>
              <div class="content" >
                <div class="title" >Upload File</div>
                <div class="description">Upload your DICOM/Image file</div>
              </div>
            </div>
            <div class="disabled step" id = "diag-step">
              <i class="whmcs icon" ></i>
              <div class="content">
                <div class="title" >Run Diagnosis</div>
                <div class="description">Run diagnosis to generate report</div>
              </div>
            </div>
            <div class="disabled step" id = "report-step">
              <i class="file alternate icon"></i>
              <div class="content">
                <div class="title">View Report</div>
                <div class="description">View final report</div>
              </div>
            </div>
          </div>
        </br>
          


          <button class="ui violet basic labeled icon button"  tabindex="0" id="uppy-btn" style="margin: 1em;" onclick="upload()"><i class="upload icon" style="background-color: rgba(100, 31, 211, 0.089);"></i>Upload File
          </button>
          
        </br>
          
        <form action="{% url 'getreport' %}" method="post" >
          {% csrf_token %}
        <div class="ui input" style="margin-top: 2em;">
          <input type="text" placeholder="Enter Study Instance ID" name="studyid" id="studyidfield">
        </div>
      </br>
      <button class="ui violet fluid button" id = "diag-button" style="margin: 1em; width: 8em;  margin: auto; width: 20%;" type="submit" onclick="poll(); " style="background-color: rgba(16, 136, 136, 0.726);"><div>Diagnose</div>

      </button>

      <div class="ui teal progress " data-value="0" data-total="100" id="example5" style="margin: 3em;">
        <div class="bar"><div class="progress"></div></div>
      </div>
  </br>
        <button class="ui teal labeled icon disabled button" id = "report-download" onclick="" style="margin: 1em;"><i class="file alternate icon" style="background-color: rgba(100, 31, 211, 0.089);"></i>View Report</button>
          <div id="drag-drop-area"></div>
        </div>
      </div>
   




<script>
function analyze(studyid){

  var http = new XMLHttpRequest();
  var url = 'http://192.168.1.196:5000/analyze';
  var params = 'study_instance_ids='.concat(studyid);
  http.open('POST', url, true);
  http.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
  http.send(params);

    }

</script>

<script>



function poll(){


/*
var studyid = "1.2.826.0.1.3680043.8.1678.101.10637286812405600288.433720";
var progressurl = "http://192.168.1.196:5000/get_progress_percents?study_instance_ids=".concat(studyid);
    
$.ajax({ url: 'http://192.168.1.196:5000/get_progress_percents', data : {study_instance_ids : "1.2.826.0.1.3680043.8.1678.101.10637286812405600288.433720"},type:"post", contentType: 'application/json',success: function(data){
  //Update your dashboard gauge
  document.getElementById("example5").setAttribute("data-value",data['status']);

 }, dataType: "json", complete: function() {
            setTimeout(poll, 5000)
        }, timeout: 2000 });;

*/
var studyid = document.getElementById("studyidfield").value;


var status_percent = "";
let data = 'study_instance_ids='.concat(studyid);




fetch("http://192.168.1.196:5000/get_progress_percents?".concat(data), {
  method: "POST", 
  headers: {
      'Content-Type': 'application/x-www-form-urlencoded'
      // 'Content-Type': 'application/x-www-form-urlencoded',
    },
}).then(res => {res.json().then(function(data) {
        status_percent = data.status;

        if (status_percent == "") {
            $('body')
            .toast({
              class: 'error',
              message: `An error occured !`
            })
          ;}
          
else if (status_percent == "100") {
  $('body')
  .toast({
    class: 'warning',
    message: `Report already analyzed !`
  })
;
} 
else{

var interval = setInterval(function() { 
   if (document.getElementById("example5").getAttribute("data-value") < 100) { 
    var http = new XMLHttpRequest();
var url = 'http://192.168.1.196:5000/get_progress_percents';
var params = 'study_instance_ids='.concat(studyid);
console.log(params)
http.open('POST', url, true);

//Send the proper header information along with the request
http.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');

http.onreadystatechange = function() {//Call a function when the state changes.
    if(http.readyState == 4 && http.status == 200) {
      $('#example5').progress({
    percent: JSON.parse(http.responseText).status,
    text: {
      active  : 'Analyzing {value} % ',
      success : 'Report Completed!'
    },
    onSuccess: function(response){
    document.getElementById("report-download").classList.remove('disabled');
    $('#app-body')
      .toast({
        message: 'Report Generated',
        class : 'teal',
        className: {
        toast: 'ui message'
    }
      })

    document.getElementById("diag-step").classList.add('completed');
    document.getElementById("report-step").classList.remove('disabled');
    document.getElementById("report-step").classList.add('active');
    ;
  }
  })
;

document.getElementById("example5").setAttribute("data-value",JSON.parse(http.responseText).status);
      console.log(JSON.parse(http.responseText).status);
  // do something with your data   
    }
}
http.send(params);



   }
   else { 
      clearInterval(interval);
   }
}, 10000);

}
        console.log(status_percent);
        
      });

});





  }



</script>



<script src="https://releases.transloadit.com/uppy/v1.27.0/uppy.min.js"></script>

<script>

    function title_progress() {

  var pageTitle = document.title;
  var percentTitle = '10% is completed';
  var blinkEvent = null;

  document.addEventListener('visibilitychange', function(e) {
    var isPageActive = !document.hidden;

    if(!isPageActive){
      blink();
    }else {
      document.title = pageTitle;
      clearInterval(blinkEvent);
    }
  });

  function blink(){
    blinkEvent = setInterval(function() {
      if(document.title === percentTitle){
        document.title = pageTitle;
      }else {
        document.title = percentTitle;
      }
    }, 100);
  }
};
   
  var allowedfiles=[];
    var uppy = Uppy.Core({
            debug: true,
            restrictions: {
                maxFileSize: 1000000,
                maxNumberOfFiles: 10,
                minNumberOfFiles: 1,
                allowedFileTypes:allowedfiles
            }
            })
            uppy.use(Uppy.Dashboard, {
            target: '#drag-drop-area',
            theme:'dark',
            browserBackButtonClose: true,
			closeModalOnClickOutside: true,
			closeAfterFinish: true,
            onRequestCloseModal: () => {
                    uppy.getPlugin('Dashboard').closeModal();
                },

            })
            uppy.use(Uppy.Tus, {endpoint: 'https://tusd.tusdemo.net/files/'})
            const Url = Uppy.Url
            uppy.on('complete', (result) => {
                console.log('Upload complete! Weâ€™ve uploaded these files:', result.successful)
                document.getElementById("diag-button").classList.remove('disabled');
                $('#app-body')
                .toast({
                    message: 'File Uploaded',
                    class : 'teal',
                    className: {
                    toast: 'ui message'
                }
                })
                document.getElementById("upload-step").classList.add('completed');
                document.getElementById("diag-step").classList.remove('disabled');
                document.getElementById("diag-step").classList.add('active');
                title_progress();
                
            })
    var value='FileType';
    $('.ui.dropdown').dropdown('setting', 'onChange', function(){
        value = $('#ftype').dropdown('get value');
    });
    function upload()
    {

            uppy.getPlugin('Dashboard').openModal();
    }
</script>

{% endblock content %}